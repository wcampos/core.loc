#!/bin/bash

#D1SRV=(i-0ef1f1cc645a87543 i-0145289c4a5c28fe2 i-0c41238a8082df7a3 i-0ccf08ed26908a73d i-0da909699e70d39b2 i-07b7d0deefce527ea i-069256f3e1c6619fe i-0df7fddf43686d468 i-0a9b97ca273ff7a4d i-08de69883d74233bb i-0aaca2c762698e537 i-0e31ce25da3f13b2b i-055dc52abd91a8737 i-064fc63fd021eacb5 i-09474f2edd7083ed4 i-0b991515a059a752a i-05ec006b1ae20d08e i-0eff49746da3531f8 i-0094bd0302c535852 i-017bb886d0ec5a87f i-046c0438fffb3dd75 i-0fd48d898d8bae7fc i-0334ef87dd370e3c2 i-0f79f84ebd797ec4b i-08256a660e611d48b i-0ca054e6d3eea2cb4 i-09e4ee19e000a0d44 i-092e03dadf80104d5 i-0bd429e09a84358b9 i-025b2e6c62a4f3a61 i-022f8df3c36a85115 i-0e8e3bfb98ca85215 i-0abd541147e41ce3b i-05f228e73bc3d1135 i-0a1098ee496564c2a i-096557d63b8957ac1 i-0bf000aea535fd1e2 i-04c3ff9e084100c97 i-0d4e18a5e1a3d481d i-0aca679dbcb0f41aa i-0cc991062a4032379 i-0d44cf22b62bbb0d7 i-0c8dad7c34c9462b6 i-0d89b620f346d2e88 i-06ff70179ad7dacf3 i-0523c62180e4e74d9 i-0c56523de2da04f5e i-0daa53d6b5f83efae i-06eb5f9e45554c8e0 i-0e27e98751cd28830 i-0bf8ebff338d5a601 i-0391e0ceec7449a59 i-00c1cb2870733b899 i-0a1cbb9f92733b71f i-05074ec02e1c4e767 i-0f30055848aca9bfe i-0d15122026ebf1346 i-0f3f5f11a8b79657d i-0671cc854a09f86be i-0f300f45486d1c863 i-0d7da7cb96ff5818d i-047d91d9208329e42 i-0bffbf0c0f0812575 i-0de1fc5dd07e0970b i-0bf0a4b2422a59481 i-01a91662ceaeb7814 i-045dc6e61fea89bb3 i-0cdd47e4b53314355 i-0d41c8ba28f020f1e i-0561b1f739e1a5da0 i-03c7ae8428c66dec2)
D1SRV=(i-0523c62180e4e74d9)

for SRV in $D1SRV 
do 
  echo "Installing Beats in $SRV"
  aws ssm send-command --document-name "AWS-RunPowerShellScript" --document-version "1" --targets '[{"Key":"InstanceIds","Values":["'$SRV'"]}]' --parameters '{"commands":["$BucketName=\"csre-demo-opsw-001\"","$Region=\"us-east-1\"","$MetricBeatZip=\"metricbeat-7.6.2-windows-x86_64.zip\"","$MetricBeatFiles=\"metricbeat-config-files.zip\"","$ElasticBasePath='"'"'D:\\elastic'"'"'","$TmpPath='"'"'C:\\tmp'"'"'","","If(!(Test-Path $ElasticBasePath)){","","mkdir -p $ElasticBasePath -ea 0","","Import-Module AWSPowerShell","powershell.exe -Command Read-S3Object -BucketName $BucketName -Region $Region -Key $MetricBeatZip -File $TmpPath\\$MetricBeatZip","powershell.exe -Command Read-S3Object -BucketName $BucketName -Region $Region -Key $MetricBeatFiles -File $TmpPath\\$MetricBeatFiles","","Expand-Archive -Path $TmpPath\\$MetricBeatZip -DestinationPath $ElasticBasePath -Force","Rename-Item -Path \"$ElasticBasePath\\metricbeat*\" -NewName \"$ElasticBasePath\\metricbeat\"","","PowerShell.exe -ExecutionPolicy UnRestricted -File $ElasticBasePath\\metricbeat\\install-service-metricbeat.ps1","","Expand-Archive -Force -Path $TmpPath\\$MetricBeatFiles -DestinationPath \"$ElasticBasePath\\metricbeat\\\"","","Get-Service -Name metricbeat | Set-Service -Status Running","","} else {"," Write-Output \"MetricBeats already Installed!\"","}"],"workingDirectory":[""],"executionTimeout":["3600"]}' --timeout-seconds 600 --max-concurrency "50" --max-errors "0" --output-s3-bucket-name "csre-demo-opsw-001" --output-s3-key-prefix "./ssm-powershell-logs/" --region us-east-1
done
